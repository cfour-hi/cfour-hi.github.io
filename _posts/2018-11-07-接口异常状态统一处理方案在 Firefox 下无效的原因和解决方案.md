---
title: æ¥å£å¼‚å¸¸çŠ¶æ€ç»Ÿä¸€å¤„ç†æ–¹æ¡ˆåœ¨ Firefox ä¸‹æ— æ•ˆçš„åŸå› å’Œè§£å†³æ–¹æ¡ˆ
categories: [æŠ€æœ¯]
tags: [æµè§ˆå™¨, Firefox, Webpack, Babel, Promise, Axios]
---

æ²¡æƒ³åˆ°ä¼šæ˜¯åœ¨åŒåä¸€è¿™ä¹ˆå¿™çš„æ—¶é—´æ®µæŠŠè¿™ç¯‡æ–‡ç« å†™å®Œ ğŸ˜‚ï¼Œå…¬å¸å¾ˆå¿™å¾ˆç´§å¼ ï¼Œå¯æˆ‘è¿˜æœ‰æ—¶é—´åœ¨å…¬å¸åšåˆ†äº«ï¼Œå†™åšæ–‡ï¼Œæƒ­æ„§æƒ­æ„§... åšåå°ç³»ç»Ÿåœ¨åŒåä¸€æœŸé—´ä¸å¦‚ 2c ç«¯çš„å°ä¼™ä¼´æœ‰å‚ä¸æ„Ÿå‘€ã€‚

## é—®é¢˜æ ¹æº

ä¸Šæ–‡ [æ¥å£å¼‚å¸¸çŠ¶æ€ç»Ÿä¸€å¤„ç†æ–¹æ¡ˆï¼šä¼˜å…ˆä¸šåŠ¡ç«¯å¤„ç†ï¼Œå†æŒ‰éœ€ç»Ÿä¸€å¤„ç†ã€‚](/posts/æ¥å£å¼‚å¸¸çŠ¶æ€ç»Ÿä¸€å¤„ç†æ–¹æ¡ˆ-ä¼˜å…ˆä¸šåŠ¡ç«¯å¤„ç†-å†æŒ‰éœ€ç»Ÿä¸€å¤„ç†/) æœ€åæå‡ºå¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼š  
å¦‚æœé¡¹ç›®æ˜¯ç”± vue-cli æ­å»ºçš„ webpack æ¨¡æ¿é¡¹ç›®ï¼Œåœ¨æ²¡æœ‰ä¿®æ”¹ .babelrc æ–‡ä»¶é…ç½®çš„æƒ…å†µä¸‹ï¼Œæ­¤æ–¹æ¡ˆåœ¨ Firefox æµè§ˆå™¨ä¸‹æ˜¯æ— æ•ˆçš„ã€‚æ¥å£çŠ¶æ€å¼‚å¸¸çš„æƒ…å†µä¸‹ï¼Œæ€»æ˜¯ä¼šæ‰§è¡Œç»Ÿä¸€å¤„ç†ï¼Œä¸ä¼šå…ˆäº¤ç”±ä¸šåŠ¡ç«¯å¤„ç†å¼‚å¸¸ï¼Œå†åˆ¤å®šæ˜¯å¦æ‰§è¡Œç»Ÿä¸€å¤„ç†ã€‚

é€šè¿‡ debug å‘ç°ï¼ŒhandleAPIStatusError å‡½æ•°æ€»æ˜¯åœ¨ catch å‡½æ•°ä¹‹å‰å…ˆæ‰§è¡Œï¼Œå¯¼è‡´æ¯æ¬¡éƒ½èƒ½åœ¨ handleAPIStatusError å‡½æ•°å†…æ‰¾åˆ°æœªå¤„ç†çš„å¼‚å¸¸æ¥å£çš„ apiUidã€‚è¿™å°±å¥‡æ€ªäº†ï¼ŒPromise æ˜¯ micro-taskï¼ŒsetTimeout æ˜¯ macro-taskï¼Œæ€»ä¸å¯èƒ½æ˜¯ EvenLoop çš„é—®é¢˜å§ ğŸ™„ï¼Œä¸å¯èƒ½ä¸å¯èƒ½ï¼Œæƒ³å¤šäº†ã€‚ğŸ’€  
é‚£åˆ°åº•æ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Ÿåªèƒ½èµ°ä»£ç äº†ï¼ŒGo Go Go... ç„¶ååœ¨ Firefox å¼€å‘è€…å·¥å…·å†…ï¼Œå‘ç°åœ¨ polyfill.js å†… Promise çš„å«ç‰‡å‡½æ•° then å’Œ catch å†…éƒ¨ï¼Œthis çš„å±æ€§ä¸­å±…ç„¶æ²¡æœ‰ apiUidï¼è€Œä¸”è¿˜æœ‰ä¸€å †è«åå…¶å¦™ä¸æ˜æ‰€ä»¥çš„å±æ€§ã€‚ğŸ˜³  
æ€ä¹ˆè‚¥å››ï¼ŸğŸ¤”

![promise-no-apiUid](http://phtkflyvc.bkt.clouddn.com/promise-no-apiUid.png)

æˆ‘è¡¨ç¤ºçœ‹ä¸æ‡‚ï¼Œthis ä¸åº”è¯¥æ˜¯ Promise çš„å®ä¾‹å—ï¼Ÿç°åœ¨è¿™ä¸ªæ˜¯ä¸ªä»€ä¹ˆé¬¼ï¼ŸğŸ’€

ç»è¿‡ä¸€ç•ªæŒ£æ‰ï¼Œçªç„¶å‘ç°ï¼š  
â€œå’¦ï¼ŒPromise å“ªå»äº†ï¼Ÿâ€  
â€œé‚£ä¸ª `__WEBPACK_IMPORTED_MODULE_0_babel_runtime_core_js_promise___default` æ˜¯ä»€ä¹ˆé¬¼ï¼Ÿâ€  
ç„¶å... çªç„¶é†’æ‚Ÿ ğŸ˜ 

babel_runtime_core_js_promiseï¼Ÿ  
core_jsï¼Ÿ  
babel-polyfillï¼Ÿ  
babel_runtimeï¼Ÿ  
babel-transform-runtimeï¼Ÿ  
éš¾é“ Firefox å†…ç½®çš„ Promise æ˜¯å‡çš„ï¼Ÿ  
ä¸€è„¸æƒŠæ‚š... ğŸ˜±

å¸¦ç€ç–‘æƒ‘çš„å¿ƒæ€å»æŸ¥æ‰¾ babel-polyfill` çš„æºç ï¼Œæ‰¾åˆ° Promise çš„å«ç‰‡å‡½æ•°ï¼š

```js
// ...
var USE_NATIVE = !!(function () {
  try {
    // correct subclassing with @@species support
    var promise = $Promise.resolve(1);
    var FakePromise = ((promise.constructor = {})[
      require("./_wks")("species")
    ] = function (exec) {
      exec(empty, empty);
    });
    // unhandled rejections tracking support, NodeJS Promise without it fails @@species test
    return (
      (isNode || typeof PromiseRejectionEvent == "function") &&
      promise.then(empty) instanceof FakePromise
    );
  } catch (e) {
    /* empty */
  }
})();
// ...
```

è¿™ä¸ª `USE_NATIVE` å°±æ˜¯åˆ¤å®šæ˜¯å¦ä½¿ç”¨æµè§ˆå™¨å†…ç½® Promise çš„å…³é”®å˜é‡ï¼Œæœä¸å…¶ç„¶ï¼Œåœ¨ Firefox ä¸­ï¼Œè¿™ä¸ªå€¼ä¸º falseï¼›å†å» Chrome æŸ¥çœ‹ï¼Œå‘ç°å€¼ä¸º trueï¼Œæˆ‘æƒ³ï¼Œé—®é¢˜çš„æ ¹æºå·²ç»æ‰¾åˆ°äº†ã€‚

## ç©¶å…¶æ ¹æº

ä¸ºä»€ä¹ˆ Firefox ä¸­ `USE_NATIVE` çš„å€¼ä¸º falseï¼Œé€šè¿‡è·Ÿè¸ªä»£ç å‘ç°ï¼Œå…³é”®ç‚¹åœ¨äº PromiseRejectionEvent è¿™ä¸ªæ¥å£ï¼ŒFirefox ä¸­å¹¶æ²¡æœ‰å®ç°ã€‚

![caniuse-PromiseRejectionEvent](http://phtkflyvc.bkt.clouddn.com/caniuse-PromiseRejectionEvent.png)

æ¢³ç†ä¸€ä¸‹ï¼Œç”±äº Firefox æ²¡æœ‰å®ç° PromiseRejectionEvent æ¥å£ï¼Œå¯¼è‡´ babel-polyfill åœ¨åˆ¤å®šæ˜¯å¦ä½¿ç”¨ Promise å«ç‰‡å‡½æ•°æ—¶ï¼Œè®¤ä¸ºå½“å‰è¿è¡Œç¯å¢ƒæ˜¯éœ€è¦ä½¿ç”¨çš„ï¼Œæ‰€ä»¥ Firefox ä¸‹çš„ Promise è¢«è¦†å†™ã€‚ç„¶åå› ä¸º babel-transform-runtime æ’ä»¶çš„å…³ç³»ï¼Œä¸ºäº†é¿å…å…¨å±€æ±¡æŸ“ï¼Œåˆå°† Promise åšäº†æ¨¡å—åŒ–å¤„ç†ï¼Œä¹Ÿå°±æ˜¯ä¸šåŠ¡ä»£ç ä¸­çš„ Promise å…¨éƒ½ä½¿ç”¨çš„æ˜¯è¢« babel-transform-runtime æ¨¡å—åŒ–è½¬æ¢åçš„ Promiseã€‚

è™½è¯´æ˜¯åšäº†æ¨¡å—åŒ–å¤„ç† Promiseï¼Œé‚£ä¸ºä»€ä¹ˆæ¥å£å±‚ Promise å®ä¾‹çš„å±æ€§ä¸­ä¼šæ²¡æœ‰ apiUidï¼Ÿ

è¡¨è±¡æ˜¯ç¼ºå¤±äº† apiUid å±æ€§ï¼Œé‚£å°±ä»æ¥å£è¯·æ±‚çš„æ ¹æºå¼€å§‹æ‰¾åŸå› ï¼Œä»æœ€å¼€å§‹è¯·æ±‚çš„è°ƒç”¨å‡½æ•°å¼€å§‹è°ƒè¯•ã€‚  
å°±å½“è¿›å…¥åˆ° axios æºç è°ƒè¯•æ—¶å‘ç°ï¼š

![Axios.prototype.request](http://phtkflyvc.bkt.clouddn.com/Axios.prototype.request%20.png)

axios æºç é‡Œé¢ä½¿ç”¨çš„ Promise æ˜¯å…¨å±€çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¸šåŠ¡ä»£ç å†…çš„ Promise ä¸ axios ä½¿ç”¨çš„ Promise ä¸æ˜¯åŒä¸€ä¸ª Promiseï¼Œå‘ƒ... ğŸ˜³

ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿè¿˜æ˜¯å¾—ä»æ ¹æºæ€è€ƒï¼Œwebpack æ‰“åŒ…æ„å»ºæˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç ï¼Œ`.js` æ–‡ä»¶çš„å¤„ç†éƒ½æ˜¯é€šè¿‡ babel-loader æ’ä»¶ï¼Œwait...wait...wait... axios æ˜¯å±äºç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œæ–‡ä»¶ä½ç½®å¤„äº node_modules ç›®å½•ä¸‹ï¼Œbabel-loader è‚¯å®šæ˜¯åšäº† include æˆ– exclude é…ç½®çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ axios çš„æºç å¹¶æ²¡æœ‰è¢« babel-transform-runtime åšå¤„ç†ï¼Œå—¦å˜... ğŸ˜¤

```js
// ...
{
  test: /\.js$/,
  loader: 'babel-loader?cacheDirectory',
  include: [
    resolve('src'),
    resolve('test'),
    resolve('node_modules/webpack-dev-server/client'),
  ],
},
// ...
```

OKï¼Œä¸ºä»€ä¹ˆä¸šåŠ¡ä»£ç ä¸ axios æºç ä½¿ç”¨çš„ä¸æ˜¯åŒä¸€ä¸ª Promise çš„åŸå› å·²ç»æ‰¾åˆ°äº†ï¼Œé‚£å¯¹æˆ‘ä»¬çš„æ¥å£å¼‚å¸¸å¤„ç†é€»è¾‘åˆæœ‰ä»€ä¹ˆå½±å“äº†ï¼Ÿ

ç”±äº axios æºç å†…çš„ Promise æ²¡æœ‰è¢« babel-transform-runtime æ¨¡å—åŒ–å¤„ç†ï¼Œæ¥å£è°ƒç”¨åº•å±‚ä½¿ç”¨çš„ä¹Ÿå°±æ˜¯å…¨å±€çš„ Promiseï¼Œä¹Ÿå°±æ˜¯è¯´è¢«è¦†å†™çš„ axios.Axios.prototype.request å‡½æ•°è¿”å›çš„æ˜¯å…¨å±€ Promise çš„å®ä¾‹ã€‚  
é‚£å…¶å®æ¥å£è°ƒç”¨æ—¶ä½¿ç”¨çš„ then æ–¹æ³•å’Œ catch æ–¹æ³•éƒ½æ˜¯å…¨å±€ Promise çš„å®ä¾‹æ–¹æ³•ï¼Œä¸æˆ‘ä»¬åœ¨ polyfill.js å†…è¦†å†™ Promise.prototype.then æ–¹æ³•å’Œ Promise.prototype.catch æ–¹æ³•æ¯«æ— ç“œè‘›ã€‚ç†æ‰€å½“ç„¶ï¼Œæˆ‘ä»¬çš„å¼‚å¸¸çŠ¶æ€ç»Ÿä¸€å¤„ç†æ–¹æ¡ˆè‚¯å®šå°±æ— æ³•ç”Ÿæ•ˆã€‚

## è§£å†³æ–¹æ¡ˆ

é—®é¢˜çš„åŸå› å·²ç»æ‰¾åˆ°ï¼Œé‚£æ€è€ƒå¦‚ä½•è§£å†³å§ã€‚

æ—¢ç„¶æ˜¯ babel-polyfill ä»£ç é€ æˆçš„é—®é¢˜ï¼Œé‚£ç§»é™¤ babel-polyfillï¼Ÿ  
è‚¯å®šä¸è¡Œï¼ŒES6+ çš„å®ä¾‹æ–¹æ³•æ€ä¹ˆåŠï¼Ÿ

é‚£æ—¢ç„¶æ˜¯ babel-transform-runtime æ’ä»¶å°† Promise åšäº†æ¨¡å—åŒ–å¤„ç†ï¼Œé‚£ç§»é™¤ babel-transform-runtimeï¼Ÿ  
ä¹Ÿä¸è¡Œï¼Œè¿™æ · babel å°±ä¼šåœ¨æ¯ä¸ªæ‰“åŒ…åçš„æ–‡ä»¶å†…æ’å…¥é‡å¤ç›¸åŒçš„ helper å‡½æ•°ã€‚

è¿™æ ·ä¸è¡Œï¼Œé‚£ä¹Ÿä¸è¡Œï¼Œåˆ°åº•å’‹æ•´ï¼ŸğŸ¤”  
è¿˜æ˜¯å¾—ä»é—®é¢˜æ ¹æºå‡ºå‘ï¼Œæˆ‘ä»¬éœ€è¦ babel-transform-runtime æ¨¡å—åŒ– helper ä»£ç ï¼Œä¹Ÿéœ€è¦ babel-polyfill æä¾›å®ä¾‹æ–¹æ³•å…¼å®¹æµè§ˆå™¨ã€‚è¿™å…¶ä¸­å°±æœ‰ä¸€ä¸ªæŒºçŸ›ç›¾çš„é—®é¢˜ï¼Œbabel-transform-runtime ä¼šæ¨¡å—åŒ–ä»£ç ï¼Œè€Œ babel-polyfill åˆæ±¡æŸ“å…¨å±€ç¯å¢ƒï¼Œåº”è¯¥æ€ä¹ˆè§£å¼€è¿™å…¶ä¸­çš„çº è‘›ï¼Ÿ  
å…¶å®è¿™æ—¶å€™å°±éœ€è¦æˆ‘ä»¬å¼„æ¸… babel-transform-runtime å’Œ babel-polyfill å®ƒä»¬çš„ä½¿ç”¨åœºæ™¯ï¼Œå®ƒä»¬æ˜¯ä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜è€Œäº§ç”Ÿçš„ã€‚

- [babel-plugin-transform-runtime](https://babeljs.io/docs/en/6.26.3/babel-plugin-transform-runtime)
- [babel-polyfill](https://babeljs.io/docs/en/6.26.3/babel-polyfill)

babel-transform-runtime çš„äº§ç”Ÿä¸»è¦æ˜¯ä¸ºäº†è§£å†³ library ä»£ç éœ€è¦è½¬æ¢æˆ ES5ï¼Œä½†åˆä¸ç¡®å®šå®¿ä¸»ç¯å¢ƒï¼Œæ— æ³•ç›´æ¥ä½¿ç”¨ babel-polyfillï¼›ä»£ç è½¬åŒ–è¿‡ç¨‹ä¸­ä¼šäº§ç”Ÿä¸€äº› helper å‡½æ•°ï¼Œåœ¨å¤šæ–‡ä»¶çš„æƒ…å†µä¸‹å°±ä¼šåœ¨å¤šä¸ªæ–‡ä»¶å†…éƒ½æ·»åŠ  helper å‡½æ•°ï¼Œå¯¼è‡´ä¸å¿…è¦çš„é‡å¤ï¼Œæ‰€ä»¥è¿›è¡Œæ¨¡å—åŒ– helper å‡½æ•°å¤„ç†ï¼›ä¸ºäº†ä¸æ±¡æŸ“å…¨å±€ç¯å¢ƒï¼Œä¼šå°† polyfill å’Œ regenerator å‡½æ•°ä¹Ÿè¿›è¡Œæ¨¡å—åŒ–å¤„ç†ã€‚  
æ‰€ä»¥ babel-transform-runtime ä¸»è¦è§£å†³ library ä¸ç¡®å®šå®¿ä¸»å’Œ helper ä»£ç æ¨¡å—åŒ–ç­‰ç›¸å…³çš„é—®é¢˜ã€‚

babel-polyfill æä¾›çš„å°±æ˜¯å®Œæ•´çš„å«ç‰‡å‡½æ•°ï¼ˆAPIã€é™æ€æ–¹æ³•ã€å®ä¾‹æ–¹æ³•ï¼‰ï¼Œä»¥å…¼å®¹ç›®å‰å„å®¶æµè§ˆå™¨è§„èŒƒä¸ç»Ÿä¸€çš„é—®é¢˜ã€‚

ä»¥ä¸Šï¼Œå°±æ˜¯ babel-transform-runtime å’Œ babel-polyfill åº”ç”¨åœºæ™¯å’Œäº§ç”ŸèƒŒæ™¯ã€‚é‚£é’ˆå¯¹æˆ‘ä»¬ç³»ç»Ÿè€Œè¨€ï¼Œè‚¯å®šæ˜¯å¿…é¡»ä½¿ç”¨ babel-polyfill çš„ï¼Œå› ä¸º **babel æ— æ³•è½¬è¯‘å®ä¾‹æ–¹æ³•**ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‹¿ babel-transform-runtime å¼€åˆ€ã€‚  
ç¨ä½œæ€è€ƒï¼Œå±¡å±¡å…¶ä¸­çš„å…³ç³»å°±ä¼šå‘ç°ï¼Œé’ˆå¯¹æˆ‘ä»¬ç³»ç»Ÿåº”ç”¨ç¨‹åºè€Œè¨€ï¼Œéœ€è¦ babel-transform-runtime å¯¹ polyfill è¿›è¡Œæ¨¡å—åŒ–å—ï¼Ÿè€Œä¸”æˆ‘ä»¬è¿˜å¿…é¡»ä½¿ç”¨ babel-polyfillã€‚

æ‰€ä»¥ï¼Œè§£å†³æ–¹æ¡ˆå°±å¾ˆæ¸…æ™°äº†ï¼Œå°† babel-transform-runtime çš„ polyfill é…ç½®è®¾ç½®ä¸º false å³å¯ã€‚

```js
*** .babelrc ***
// ...
"plugins": [
  "transform-vue-jsx",
  ["transform-runtime", {
    "polyfill": false
  }]
]
// ...
```

_è²Œä¼¼ regenerator å‡½æ•°ä¹Ÿæ²¡å¿…è¦æ¨¡å—åŒ–ï¼Œä¸è¿‡æˆ‘ä»¬æš‚æ—¶ä¸ç®¡å®ƒå§ã€‚_

Over
